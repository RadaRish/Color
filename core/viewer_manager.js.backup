export default class ViewerManager {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.aframeScene = null;
        this.aframeCamera = null;
        this.aframeSky = null;
        this.currentPanorama = null;
        this.zoomSpeed = 1.0; // –°–∫–æ—Ä–æ—Å—Ç—å –∑—É–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        this.initializeViewer();
    }

    initializeViewer() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º A-Frame —Å—Ü–µ–Ω—É
        this.initializeAFrame();
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç billboard –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
        if (!AFRAME.components['billboard']) {
            AFRAME.registerComponent('billboard', {
                tick: function () {
                    const camera = this.el.sceneEl.camera;
                    if (camera) {
                        this.el.object3D.lookAt(camera.getWorldPosition(new THREE.Vector3()));
                    }
                }
            });
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç hotspot-handler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
        if (typeof AFRAME !== 'undefined') {
            AFRAME.registerComponent('hotspot-handler', {
                schema: {
                    hotspotId: {type: 'string'},
                    hotspotTitle: {type: 'string'},
                    hotspotType: {type: 'string'}
                },
                init: function () {
                    const el = this.el;
                    const data = this.data;
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è hotspot-handler –¥–ª—è:', data.hotspotTitle);
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç raycaster
                    el.addEventListener('raycaster-intersected', (e) => {
                        console.log('Raycaster intersected:', data.hotspotTitle);
                        el.emit('mouseenter');
                    });
                    
                    el.addEventListener('raycaster-intersected-cleared', (e) => {
                        console.log('Raycaster cleared:', data.hotspotTitle);
                        el.emit('mouseleave');
                    });
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                    el.addEventListener('mouseenter', (e) => {
                        console.log('A-Frame mouseenter:', data.hotspotTitle);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip
                        const markerEl = el.parentElement;
                        const textContainer = markerEl.querySelector('a-entity');
                        if (textContainer) {
                            const text = textContainer.querySelector('a-text');
                            const textBackground = textContainer.querySelectorAll('a-plane')[1];
                            const textBorder = textContainer.querySelectorAll('a-plane')[0];
                            
                            if (text) {
                                text.setAttribute('visible', 'true');
                                if (textBackground) textBackground.setAttribute('visible', 'true');
                                if (textBorder) textBorder.setAttribute('visible', 'true');
                                console.log('Tooltip –ø–æ–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç');
                            }
                        }
                    });
                    
                    el.addEventListener('mouseleave', (e) => {
                        console.log('A-Frame mouseleave:', data.hotspotTitle);
                        // –°–∫—Ä—ã–≤–∞–µ–º tooltip
                        const markerEl = el.parentElement;
                        const textContainer = markerEl.querySelector('a-entity');
                        if (textContainer) {
                            const text = textContainer.querySelector('a-text');
                            const textBackground = textContainer.querySelectorAll('a-plane')[1];
                            const textBorder = textContainer.querySelectorAll('a-plane')[0];
                            
                            if (text) {
                                text.setAttribute('visible', 'false');
                                if (textBackground) textBackground.setAttribute('visible', 'false');
                                if (textBorder) textBorder.setAttribute('visible', 'false');
                                console.log('Tooltip —Å–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç');
                            }
                        }
                    });
                    
                    el.addEventListener('click', (e) => {
                        console.log('A-Frame click:', data.hotspotTitle, data.hotspotType);
                        // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç–∞ –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
                        const hotspotId = data.hotspotId;
                        const hotspot = window.hotspotManager ? window.hotspotManager.findHotspotById(hotspotId) : null;
                        
                        if (hotspot) {
                            if (hotspot.type === 'hotspot' && hotspot.targetSceneId) {
                                console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ü–µ–Ω—É:', hotspot.targetSceneId);
                                window.sceneManager.switchToScene(hotspot.targetSceneId);
                            } else if (hotspot.type === 'info-point') {
                                console.log('–ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏');
                                window.viewerManager.showInfoPointModal(hotspot);
                            }
                        }
                    });
                }
            });
        }
    }

    initializeAFrame() {
        // –°–æ–∑–¥–∞–µ–º A-Frame —Å—Ü–µ–Ω—É
        this.aframeScene = document.createElement('a-scene');
        this.aframeScene.setAttribute('embedded', 'true');
        this.aframeScene.setAttribute('style', 'width: 100%; height: 100%; cursor: grab;');
        this.aframeScene.setAttribute('cursor', 'rayOrigin: mouse');
        this.aframeScene.setAttribute('raycaster', 'objects: .interactive');
        this.aframeScene.setAttribute('vr-mode-ui', 'enabled: false');
        
        // –°–æ–∑–¥–∞–µ–º assets –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤
        const assets = document.createElement('a-assets');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
        const fontAsset = document.createElement('a-mixin');
        fontAsset.setAttribute('id', 'cyrillic-font');
        fontAsset.setAttribute('text', 'font: roboto; shader: sdf');
        assets.appendChild(fontAsset);
        
        this.aframeScene.appendChild(assets);

        // –°–æ–∑–¥–∞–µ–º –∫–∞–º–µ—Ä—É
        const camera = document.createElement('a-entity');
        camera.setAttribute('camera', 'fov: 80; zoom: 1');
        camera.setAttribute('look-controls', 'enabled: true');
        camera.setAttribute('wasd-controls', 'enabled: false');
        camera.id = 'camera';
        this.aframeScene.appendChild(camera);

        // –°–æ–∑–¥–∞–µ–º –∫—É—Ä—Å–æ—Ä
        const cursor = document.createElement('a-cursor');
        cursor.setAttribute('animation__click', 'property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150');
        cursor.setAttribute('animation__fusing', 'property: scale; startEvents: fusing; from: 1 1 1; to: 0.1 0.1 0.1; dur: 1500');
        cursor.setAttribute('raycaster', 'objects: .interactive');
        camera.appendChild(cursor);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        this.container.appendChild(this.aframeScene);
        
        console.log('A-Frame —Å—Ü–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã');
    }
    }

    async setPanorama(imageSrc) {
        if (!this.aframeSky) return false;
        
        try {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–∞–Ω–æ—Ä–∞–º—ã
            this.aframeSky.setAttribute('src', imageSrc);
            this.currentPanorama = imageSrc;
            console.log('–ü–∞–Ω–æ—Ä–∞–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', imageSrc);
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–æ—Ä–∞–º—ã:', error);
            return false;
        }
    }

    setupEventHandlers() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        this.container.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            this.showContextMenu(e.clientX, e.clientY, e);
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ
        this.container.addEventListener('click', () => {
            this.hideContextMenu();
        });
    }

    showContextMenu(x, y, event) {
        this.hideContextMenu(); // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–µ–Ω—é
        
        const menu = document.createElement('div');
        menu.className = 'custom-context-menu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        menu.innerHTML = `
            <button data-type="hotspot">–î–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—Å–ø–æ—Ç</button>
            <button data-type="info-point">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ç–æ—á–∫—É</button>
        `;
        
        document.body.appendChild(menu);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
        menu.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                
                // –ü–æ–ª—É—á–∞–µ–º 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
                const intersection = this.getIntersectionPoint(event);
                if (!intersection) {
                    console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è.");
                    return;
                }

                // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è main.js
                const customEvent = new CustomEvent('context-menu-add-hotspot', {
                    detail: { type, position: `${intersection.x} ${intersection.y} ${intersection.z}` }
                });
                this.container.dispatchEvent(customEvent);

                menu.remove();
            });
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            const closeHandler = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            document.addEventListener('click', closeHandler);
        }, 0);
    }

    hideContextMenu() {
        const existingMenu = document.querySelector('.custom-context-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
    }

    getIntersectionPoint(event) {
        if (!this.aframeScene || !this.aframeCamera || !this.aframeSky) {
            return null;
        }

        // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–∫—Ä–∞–Ω–∞
        const rect = this.container.getBoundingClientRect();
        const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ —Å—Ñ–µ—Ä–µ
        const phi = (x * Math.PI);
        const theta = ((y + 1) * Math.PI / 2);
        
        const radius = 10; // –†–∞–¥–∏—É—Å –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        const position = {
            x: radius * Math.sin(theta) * Math.cos(phi),
            y: radius * Math.cos(theta),
            z: radius * Math.sin(theta) * Math.sin(phi)
        };
        
        return position;
    }

    createVisualMarker(hotspot) {
        if (!this.aframeScene) return;

        const markerEl = document.createElement('a-entity');
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è DOM-—ç–ª–µ–º–µ–Ω—Ç–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å ID —Ö–æ—Ç—Å–ø–æ—Ç–∞
        markerEl.id = `marker-${hotspot.id}`;
        markerEl.setAttribute('data-hotspot-id', hotspot.id);
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä
        markerEl.setAttribute('position', hotspot.position);

        // –î–µ–ª–∞–µ–º –º–∞—Ä–∫–µ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
        markerEl.className = 'interactive draggable';
        
        // –í–∞–∂–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å interactive –∏ –∫ shape –¥–ª—è raycaster
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        markerEl._isDragging = false;
        markerEl._tooltipVisible = false;
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
        const defaultSettings = this.getDefaultSettings();
        const radius = hotspot.size || (hotspot.type === 'hotspot' ? defaultSettings.hotspotSize : defaultSettings.infopointSize);
        const color = hotspot.color || (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);
        const icon = hotspot.icon || 'sphere';
        
        // –°–æ–∑–¥–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é
        let shape;
        console.log('–°–æ–∑–¥–∞–µ–º —Ñ–∏–≥—É—Ä—É:', icon, '—Ä–∞–∑–º–µ—Ä:', radius, '—Ü–≤–µ—Ç:', color);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–∫–æ–Ω–∫–∞
        if (icon === 'custom' && hotspot.customIconData) {
            console.log('–°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∏–∫–æ–Ω–∫—É');
            
            // –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            shape = document.createElement('a-plane');
            
            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
            const textureId = `custom-texture-${hotspot.id}`;
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç img –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
            const img = document.createElement('img');
            img.id = textureId;
            img.src = hotspot.customIconData;
            img.crossOrigin = 'anonymous';
            img.style.display = 'none';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ assets
            let assets = this.aframeScene.querySelector('a-assets');
            if (!assets) {
                assets = document.createElement('a-assets');
                this.aframeScene.appendChild(assets);
            }
            assets.appendChild(img);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
            shape.setAttribute('material', {
                src: `#${textureId}`,
                transparent: true,
                alphaTest: 0.5
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä (–¥–ª—è –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º width –∏ height)
            shape.setAttribute('width', radius * 2);
            shape.setAttribute('height', radius * 2);
            
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–∫–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ID —Ç–µ–∫—Å—Ç—É—Ä—ã:', textureId);
            
        } else {
            // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Ñ–∏–≥—É—Ä—É
            switch (icon) {
                case 'cube':
                    shape = document.createElement('a-box');
                    shape.setAttribute('width', radius);
                    shape.setAttribute('height', radius);
                    shape.setAttribute('depth', radius);
                    break;
                case 'cylinder':
                    shape = document.createElement('a-cylinder');
                    shape.setAttribute('radius', radius);
                    shape.setAttribute('height', radius * 2);
                    break;
                case 'octahedron':
                    shape = document.createElement('a-octahedron');
                    shape.setAttribute('radius', radius);
                    break;
                default: // sphere
                    shape = document.createElement('a-sphere');
                    shape.setAttribute('radius', radius);
                    break;
            }
            
            shape.setAttribute('color', color);
            shape.setAttribute('opacity', '0.9');
            shape.setAttribute('material', 'transparent: true');
        }
        shape.className = 'interactive'; // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è raycaster
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
        shape.setAttribute('hotspot-handler', `hotspotId: ${hotspot.id}; hotspotTitle: ${hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}; hotspotType: ${hotspot.type}`);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏
        shape.setAttribute('animation__pulse', 'property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 1000; easing: easeInOutSine;');
        
        // –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        shape.setAttribute('animation__hover_on', 'property: scale; to: 1.4 1.4 1.4; startEvents: mouseenter; dur: 200;');
        shape.setAttribute('animation__hover_off', 'property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200;');

        console.log('–§–∏–≥—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞:', shape.tagName, shape.getAttribute('radius') || shape.getAttribute('width'));

        // –¢–µ–∫—Å—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ) - —Å–æ–∑–¥–∞–µ–º –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const textContainer = document.createElement('a-entity');
        textContainer.setAttribute('position', '0 0.8 0'); // –ù–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        
        const text = document.createElement('a-text');
        text.setAttribute('value', hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
        text.setAttribute('align', 'center');
        text.setAttribute('color', hotspot.textColor || '#ffffff');
        text.setAttribute('font', 'roboto');
        text.setAttribute('width', '6');
        text.setAttribute('position', '0 0 0');
        text.setAttribute('visible', 'false');
        text.setAttribute('shader', 'sdf');
        text.setAttribute('material', 'alphaTest: 0.5');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–Ω—å –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        const textShadow = document.createElement('a-text');
        textShadow.setAttribute('value', hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
        textShadow.setAttribute('align', 'center');
        textShadow.setAttribute('color', '#000000');
        textShadow.setAttribute('font', 'roboto');
        textShadow.setAttribute('width', '6');
        textShadow.setAttribute('position', '0.02 -0.02 -0.01'); // –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–Ω–∏
        textShadow.setAttribute('visible', 'false');
        textShadow.setAttribute('shader', 'sdf');
        textShadow.setAttribute('material', 'alphaTest: 0.5; opacity: 0.8');
        
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç look-at –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫ –∫–∞–º–µ—Ä–µ
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –∫ –∫–∞–º–µ—Ä–µ
        textContainer.setAttribute('billboard', '');
        
        textContainer.appendChild(textShadow);
        textContainer.appendChild(text);

        // –°–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        console.log('–°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.id, hotspot.title);
        
        // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è
        markerEl.addEventListener('mouseenter', (e) => {
            console.log('MOUSEENTER –Ω–∞ –º–∞—Ä–∫–µ—Ä:', hotspot.title);
            e.stopPropagation();
            if (!markerEl._isDragging && !markerEl._tooltipVisible) {
                text.setAttribute('visible', 'true');
                textShadow.setAttribute('visible', 'true');
                markerEl._tooltipVisible = true;
                console.log('Tooltip –ø–æ–∫–∞–∑–∞–Ω –¥–ª—è:', hotspot.title);
            }
        });
        
        markerEl.addEventListener('mouseleave', (e) => {
            console.log('MOUSELEAVE —Å –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title);
            e.stopPropagation();
            if (!markerEl._isDragging && markerEl._tooltipVisible) {
                text.setAttribute('visible', 'false');
                textShadow.setAttribute('visible', 'false');
                markerEl._tooltipVisible = false;
                console.log('Tooltip —Å–∫—Ä—ã—Ç –¥–ª—è:', hotspot.title);
            }
        });

        // –°–æ–±—ã—Ç–∏—è –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        markerEl.addEventListener('mousedown', (e) => {
            console.log('MOUSEDOWN –Ω–∞ –º–∞—Ä–∫–µ—Ä:', hotspot.title, e.button);
            if (e.button === 0) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
                e.stopPropagation();
                this.startDragging(markerEl, hotspot, e);
            }
        });

        // –ö–ª–∏–∫ –±–µ–∑ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        markerEl.addEventListener('click', (e) => {
            console.log('CLICK –Ω–∞ –º–∞—Ä–∫–µ—Ä:', hotspot.title, 'wasDragged:', markerEl._wasDragged);
            e.stopPropagation();
            if (!markerEl._wasDragged) {
                if (hotspot.type === 'hotspot' && hotspot.targetSceneId) {
                    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ü–µ–Ω—É:', hotspot.targetSceneId);
                    window.sceneManager.switchToScene(hotspot.targetSceneId);
                } else if (hotspot.type === 'info-point') {
                    console.log('–ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏');
                    this.showInfoPointModal(hotspot);
                }
            }
            markerEl._wasDragged = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        });

        // –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        markerEl.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showMarkerContextMenu(e.clientX, e.clientY, hotspot);
        });

        markerEl.appendChild(shape);
        markerEl.appendChild(textContainer);
        this.aframeScene.appendChild(markerEl);
        
        console.log('–ú–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ü–µ–Ω—É:', {
            id: markerEl.id,
            className: markerEl.className,
            position: markerEl.getAttribute('position'),
            hasShape: !!shape,
            hasTextContainer: !!textContainer,
            sceneChildren: this.aframeScene.children.length
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ DOM
        setTimeout(() => {
            const checkEl = document.getElementById(`marker-${hotspot.id}`);
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ 100ms:', !!checkEl, checkEl ? checkEl.className : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
        }, 100);
    }

    showInfoPointModal(hotspot) {
        // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏
        const modal = document.createElement('div');
        modal.className = 'info-point-modal';
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #646cff;
            border-radius: 12px;
            padding: 20px 30px;
            z-index: 10001;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.87);
        `;
        
        modal.innerHTML = `
            <h3 style="margin: 0 0 15px 0; color: #ffcc00;">${hotspot.title}</h3>
            <p style="margin: 0; line-height: 1.5; color: ${hotspot.textColor || '#ffffff'}; font-size: ${hotspot.textSize || '1'}em;">${hotspot.description || ''}</p>
            <button onclick="this.closest('.info-point-modal').remove()" 
                    style="margin-top: 15px; padding: 8px 16px; background: #646cff; border: none; border-radius: 4px; color: white; cursor: pointer;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        `;
        
        document.body.appendChild(modal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        setTimeout(() => {
            const closeHandler = (e) => {
                if (!modal.contains(e.target)) {
                    modal.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            document.addEventListener('click', closeHandler);
        }, 0);
    }

    showMarkerContextMenu(x, y, hotspot) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–µ–Ω—é
        const existingMenu = document.querySelector('.marker-context-menu');
        if (existingMenu) existingMenu.remove();
        
        const menu = document.createElement('div');
        menu.className = 'marker-context-menu custom-context-menu';
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        
        menu.innerHTML = `
            <button data-action="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button data-action="move">üìç –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
            <button data-action="delete" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        `;
        
        document.body.appendChild(menu);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
        menu.querySelector('[data-action="edit"]').addEventListener('click', () => {
            window.editMarker(hotspot.id);
            menu.remove();
        });
        
        menu.querySelector('[data-action="move"]').addEventListener('click', () => {
            this.startMoveMode(hotspot);
            menu.remove();
        });
        
        menu.querySelector('[data-action="delete"]').addEventListener('click', () => {
            window.deleteMarker(hotspot.id);
            menu.remove();
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        setTimeout(() => {
            const closeHandler = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            document.addEventListener('click', closeHandler);
        }, 0);
    }

    startMoveMode(hotspot) {
        const markerEl = document.getElementById(`marker-${hotspot.id}`);
        if (!markerEl) return;
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const shapeEl = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron');
        if (shapeEl) {
            shapeEl.setAttribute('color', '#ff00ff');
            shapeEl.setAttribute('opacity', '0.7');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        const instruction = document.createElement('div');
        instruction.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid #ff00ff;
            border-radius: 8px;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.87);
            z-index: 10000;
        `;
        instruction.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞';
        document.body.appendChild(instruction);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const moveHandler = (e) => {
            if (e.target.tagName === 'A-SKY') {
                const newPosition = this.getIntersectionPoint(e);
                if (newPosition) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ö–æ—Ç—Å–ø–æ—Ç–∞
                    hotspot.position = `${newPosition.x} ${newPosition.y} ${newPosition.z}`;
                    window.hotspotManager.updateHotspot(hotspot.id, { position: hotspot.position });
                    
                    // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥
                    this.container.removeEventListener('click', moveHandler);
                    if (shapeEl) {
                        const defaultSettings = this.getDefaultSettings();
                        const color = hotspot.color || (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);
                        shapeEl.setAttribute('color', color);
                        shapeEl.setAttribute('opacity', '0.9');
                    }
                    instruction.remove();
                }
            }
        };
        
        this.container.addEventListener('click', moveHandler);
    }

    updateVisualMarker(hotspot) {
        const markerEl = document.getElementById(`marker-${hotspot.id}`);
        if (!markerEl) return;

        // –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
        const currentShape = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron');
        const newIcon = hotspot.icon || 'sphere';
        const currentIcon = this.getShapeType(currentShape);
        
        if (currentIcon !== newIcon) {
            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –Ω–æ–≤–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π
            this.removeVisualMarker(hotspot.id);
            this.createVisualMarker(hotspot);
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
        markerEl.setAttribute('position', hotspot.position);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        const textContainer = markerEl.querySelector('a-entity');
        const textEl = textContainer ? textContainer.querySelector('a-text') : null;
        const textBackground = textContainer ? textContainer.querySelectorAll('a-plane')[1] : null; // –≤—Ç–æ—Ä–æ–π plane - —ç—Ç–æ —Ñ–æ–Ω
        const textBorder = textContainer ? textContainer.querySelectorAll('a-plane')[0] : null; // –ø–µ—Ä–≤—ã–π plane - —ç—Ç–æ —Ä–∞–º–∫–∞
        
        if (textEl) {
            textEl.setAttribute('value', hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
            textEl.setAttribute('color', hotspot.textColor || '#ffffff');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–æ–Ω–∞ –∏ —Ä–∞–º–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
            const textWidth = Math.max(2, (hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').length * 0.12);
            if (textBackground) {
                textBackground.setAttribute('width', textWidth);
            }
            if (textBorder) {
                textBorder.setAttribute('width', textWidth + 0.1);
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
        if (currentShape) {
            const defaultSettings = this.getDefaultSettings();
            const size = hotspot.size || (hotspot.type === 'hotspot' ? defaultSettings.hotspotSize : defaultSettings.infopointSize);
            const color = hotspot.color || (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);
            
            currentShape.setAttribute('color', color);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
            switch (newIcon) {
                case 'cube':
                    currentShape.setAttribute('width', size);
                    currentShape.setAttribute('height', size);
                    currentShape.setAttribute('depth', size);
                    break;
                case 'cylinder':
                    currentShape.setAttribute('radius', size);
                    currentShape.setAttribute('height', size * 2);
                    break;
                default: // sphere, octahedron
                    currentShape.setAttribute('radius', size);
                    break;
            }
        }
    }

    getShapeType(element) {
        if (!element) return 'sphere';
        const tagName = element.tagName.toLowerCase();
        switch (tagName) {
            case 'a-box': return 'cube';
            case 'a-cylinder': return 'cylinder';
            case 'a-octahedron': return 'octahedron';
            default: return 'sphere';
        }
    }

    removeVisualMarker(hotspotId) {
        const markerEl = document.getElementById(`marker-${hotspotId}`);
        if (markerEl) {
            markerEl.remove();
        }
    }

    getViewer() {
        return {
            container: this.container,
            scene: this.aframeScene,
            camera: this.aframeCamera,
            sky: this.aframeSky
        };
    }

    clearMarkers() {
        const markers = this.aframeScene.querySelectorAll('[data-hotspot-id]');
        markers.forEach(marker => marker.remove());
    }

    updateCameraSettings(settings) {
        if (this.aframeCamera && settings.mouseSensitivity) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—ã—à–∏ –¥–ª—è look-controls
            const lookControls = this.aframeCamera.getAttribute('look-controls');
            this.aframeCamera.setAttribute('look-controls', {
                ...lookControls,
                mouseSensitivity: settings.mouseSensitivity,
                touchSensitivity: settings.mouseSensitivity
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑—É–º–∞
        if (settings.zoomSpeed) {
            this.zoomSpeed = settings.zoomSpeed;
        }
    }

    getDefaultSettings() {
        const savedSettings = localStorage.getItem('panorama-editor-settings');
        if (savedSettings) {
            return JSON.parse(savedSettings);
        }
        return {
            mouseSensitivity: 1,
            zoomSpeed: 1.0,
            hotspotColor: '#00ff00',
            hotspotSize: 0.3,
            infopointColor: '#ff0000',
            infopointSize: 0.2
        };
    }

    setupZoomControls() {
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
        this.container.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            const currentFov = this.aframeCamera.getAttribute('fov');
            const zoomStep = 5 * this.zoomSpeed;
            const delta = e.deltaY > 0 ? zoomStep : -zoomStep;
            let newFov = currentFov + delta;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑—É–º
            newFov = Math.max(20, Math.min(120, newFov)); // –û—Ç 20 –¥–æ 120 –≥—Ä–∞–¥—É—Å–æ–≤
            
            this.aframeCamera.setAttribute('fov', newFov);
        });
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º –∫–Ω–æ–ø–∫–∞–º–∏ + –∏ -
        document.addEventListener('keydown', (e) => {
            if (e.key === '+' || e.key === '=') {
                this.zoomIn();
            } else if (e.key === '-') {
                this.zoomOut();
            }
        });
    }

    zoomIn() {
        const currentFov = this.aframeCamera.getAttribute('fov');
        const zoomStep = 5 * this.zoomSpeed;
        const newFov = Math.max(20, currentFov - zoomStep);
        this.aframeCamera.setAttribute('fov', newFov);
    }

    zoomOut() {
        const currentFov = this.aframeCamera.getAttribute('fov');
        const zoomStep = 5 * this.zoomSpeed;
        const newFov = Math.min(120, currentFov + zoomStep);
        this.aframeCamera.setAttribute('fov', newFov);
    }

    resetZoom() {
        this.aframeCamera.setAttribute('fov', 80);
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
    startDragging(markerEl, hotspot, startEvent) {
        markerEl._isDragging = true;
        markerEl._wasDragged = false;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
        markerEl.classList.add('dragging');
        const shape = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron');
        if (shape) {
            shape.setAttribute('opacity', '0.7');
            shape.setAttribute('material', 'transparent: true');
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º tooltip –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        const textContainer = markerEl.querySelector('a-entity');
        const text = textContainer ? textContainer.querySelector('a-text') : null;
        const textBackground = textContainer ? textContainer.querySelectorAll('a-plane')[1] : null;
        const textBorder = textContainer ? textContainer.querySelectorAll('a-plane')[0] : null;
        
        if (text && markerEl._tooltipVisible) {
            text.setAttribute('visible', 'false');
            textBackground.setAttribute('visible', 'false');
            textBorder.setAttribute('visible', 'false');
            markerEl._tooltipVisible = false;
        }

        const startPosition = this.getMarkerPosition(markerEl);
        const camera = this.aframeCamera;
        
        const onMouseMove = (e) => {
            markerEl._wasDragged = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å THREE.js
            if (typeof THREE === 'undefined') {
                console.error('THREE.js not available for dragging');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–≥–ª—è–¥–∞ –∫–∞–º–µ—Ä—ã
            const cameraRotation = camera.getAttribute('rotation');
            const cameraEl = camera.object3D;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
            const sensitivity = 0.005;
            const deltaX = (e.clientX - startEvent.clientX) * sensitivity;
            const deltaY = -(e.clientY - startEvent.clientY) * sensitivity;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏ –≤ –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            const right = new THREE.Vector3(1, 0, 0);
            const up = new THREE.Vector3(0, 1, 0);
            
            right.applyQuaternion(cameraEl.quaternion);
            up.applyQuaternion(cameraEl.quaternion);
            
            const newPosition = {
                x: startPosition.x + right.x * deltaX + up.x * deltaY,
                y: startPosition.y + right.y * deltaX + up.y * deltaY,
                z: startPosition.z + right.z * deltaX + up.z * deltaY
            };
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–¥–∏—É—Å (—á—Ç–æ–±—ã –º–∞—Ä–∫–µ—Ä –Ω–µ —É—Ö–æ–¥–∏–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ)
            const distance = Math.sqrt(newPosition.x * newPosition.x + newPosition.y * newPosition.y + newPosition.z * newPosition.z);
            if (distance > 10) {
                const scale = 10 / distance;
                newPosition.x *= scale;
                newPosition.y *= scale;
                newPosition.z *= scale;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞
            markerEl.setAttribute('position', `${newPosition.x} ${newPosition.y} ${newPosition.z}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ hotspot
            hotspot.position = `${newPosition.x} ${newPosition.y} ${newPosition.z}`;
        };

        const onMouseUp = () => {
            markerEl._isDragging = false;
            
            // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            markerEl.classList.remove('dragging');
            const shape = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron');
            if (shape) {
                shape.setAttribute('opacity', '0.9');
            }
            
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º HotspotManager –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏
            if (window.hotspotManager && markerEl._wasDragged) {
                window.hotspotManager.updateHotspotPosition(hotspot.id, hotspot.position);
            }
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    getMarkerPosition(markerEl) {
        const pos = markerEl.getAttribute('position');
        return {
            x: pos.x || 0,
            y: pos.y || 0,
            z: pos.z || 0
        };
    }
}
